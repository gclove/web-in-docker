# $Id: PKGBUILD 266697 2016-05-01 00:55:57Z seblu $
# Maintainer: shmilee
# Maintainer: Bartłomiej Piotrowski <bpiotrowski@archlinux.org>
# Maintainer: Sébastien Luttringer
# Contributor: Sergej Pupykin <pupykin.s+arch@gmail.com>
# Contributor: Miroslaw Szot <mss@czlug.icis.pcz.pl>
# Contributor: Daniel Micay <danielmicay@gmail.com>

_pkgname=nginx
_pkgver=1.10.1

### 3d party modules:
_fancyindex_name="ngx-fancyindex"
_fancyindex_ver="0.4.0"
_echo_name="echo-nginx-module"
_echo_ver="0.59"
_heads_more_name="headers-more-nginx-module"
_heads_more_ver="0.30"
_fair_name="nginx-upstream-fair"
_fair_ver="a18b4099fbd458111983200e098b6f0c8efed4bc"
_sub_filter_name="ngx_http_substitutions_filter_module"
_sub_filter_ver="bc58cb11844bc42735bbaef7085ea86ace46d05b"
_google_filter_name="ngx_http_google_filter_module"
_google_filter_ver="0.2.0"
_auth_pam_name="ngx_http_auth_pam_module"
_auth_pam_ver="1.5.1"
_concat_name="nginx-http-concat"
_concat_ver="b8d3e7ec511724a6900ba3915df6b504337891a9"

_naxsi_name="naxsi"
_naxsi_ver="0.55rc2"
_nchan_name="nchan"
_nchan_ver="0.99.16"
_rtmp_name="nginx-rtmp-module"
_rtmp_ver="c3237ae747ff0b06494326731e215c23ae884966"

_pagespeed_name="ngx_pagespeed"
_NPS_VERSION=1.11.33.2
_pagespeed_ver="${_NPS_VERSION}-beta"
### END

pkgbase=mynginx
pkgname=(mynginx mynginx-pagespeed)
pkgver=${_pkgver}
pkgrel=2
pkgdesc='Lightweight HTTP server and IMAP/POP3 proxy server - with fancyindex, echo, headers-more, upstream-fair, sub_filter, google_filter, http_auth_pam, http-concat, naxsi, nchan, rtmp support'
arch=('i686' 'x86_64')
url='http://nginx.org'
license=('custom')
depends=('pcre' 'zlib' 'openssl' 'geoip')
makedepends=('hardening-wrapper')

source=($url/download/nginx-$pkgver.tar.gz
        service
        logrotate
        ${_fancyindex_name}.tar.gz::https://github.com/aperezdc/${_fancyindex_name}/archive/v${_fancyindex_ver}.tar.gz
        ${_echo_name}.tar.gz::https://github.com/openresty/${_echo_name}/archive/v${_echo_ver}.tar.gz
        ${_heads_more_name}.tar.gz::https://github.com/openresty/${_heads_more_name}/archive/v${_heads_more_ver}.tar.gz
        ${_fair_name}.tar.gz::https://github.com/gnosek/${_fair_name}/archive/${_fair_ver}.tar.gz
        ${_sub_filter_name}.tar.gz::https://github.com/yaoweibin/${_sub_filter_name}/archive/${_sub_filter_ver}.tar.gz
        ${_google_filter_name}.tar.gz::https://github.com/cuber/${_google_filter_name}/archive/${_google_filter_ver}.tar.gz
        ${_auth_pam_name}.tar.gz::https://github.com/stogh/${_auth_pam_name}/archive/v${_auth_pam_ver}.tar.gz
        ${_concat_name}.tar.gz::https://github.com/alibaba/${_concat_name}/archive/${_concat_ver}.tar.gz
        ${_naxsi_name}.tar.gz::https://github.com/nbs-system/${_naxsi_name}/archive/${_naxsi_ver}.tar.gz
        ${_nchan_name}.tar.gz::https://github.com/slact/${_nchan_name}/archive/v${_nchan_ver}.tar.gz
        ${_rtmp_name}.tar.gz::https://github.com/sergey-dryabzhinsky/${_rtmp_name}/archive/${_rtmp_ver}.tar.gz
        psol-${_NPS_VERSION}.tar.gz::https://dl.google.com/dl/page-speed/psol/${_NPS_VERSION}.tar.gz
        ${_pagespeed_name}.tar.gz::https://github.com/pagespeed/${_pagespeed_name}/archive/v${_pagespeed_ver}.tar.gz)
sha256sums=('1fd35846566485e03c0e318989561c135c598323ff349c503a6c14826487a801'
            '4ecbc33ce4bf2965996f51b0c7edb677904ba5cff9a32e93e1487a428d3a751b'
            '2613986dd5faab09ca962264f16841c8c55c3a0bc7a5bb737eabd83143090878'
            '152cc2cf082c23cbc7b0fc76f14af4015d3988783016dc9145edebec17c7e230'
            '9b319ad7836202883128d2b9c24ed818082541df57ef7f2065b7557085c603cd'
            '2aad309a9313c21c7c06ee4e71a39c99d4d829e31c8b3e7d76f8c964ea8047f5'
            'c051d33a8732b671b33e0b3535e6fbbd82311c6d89532c4067b3d2ba738e1ce1'
            '8eabbcd5950fdcc718bb0ef9165206c2ed60f67cd9da553d7bc3e6fe4e338461'
            '9cd68c8e092efb1a419e1087bb9ca23aab1ff8650c400c0aa815d461d79385de'
            '77676842919134af88a7b4bfca4470223e3a00d287d17c0dbdc9a114a685b6e7'
            'e34ef51c299bc3d662b6c74031f7ad9775d73e84cfaa4e72810959fe1760413c'
            'fed822e3f507801ce44964908eb1dca8ec58dc0a9bc47f7e7d00c6c4ef97f78b'
            '200cc1b02931a067c3edb07243a7faac80265ce6aab37af680cf7373011efc41'
            '3245b7747fb468cb94e367c4735a29a76bcc42f46ffd8f532e165b6db71d3ca6'
            '1ccb59e81a4cdfd2d8e664c9ee1b31fa2f495aace640d4d14f58319688aaff8e'
            'dfb3c62345ea95e4aec50b449d75bcdf1c868b5c3d62d6c7e0e73632ebe20101')

_common_flags=(
  --with-ipv6
  --with-pcre-jit
  --with-file-aio
  --with-http_addition_module
  --with-http_auth_request_module
  --with-http_dav_module
  --with-http_degradation_module
  --with-http_flv_module
  --with-http_geoip_module
  --with-http_gunzip_module
  --with-http_gzip_static_module
  --with-http_mp4_module
  --with-http_realip_module
  --with-http_secure_link_module
  --with-http_ssl_module
  --with-http_stub_status_module
  --with-http_sub_module
  --with-http_v2_module
  --with-mail
  --with-mail_ssl_module
  --with-stream
  --with-stream_ssl_module
  --with-threads
)

_stable_flags=(
)

_3d_party_modules_flags=(
  --modules-path=/usr/lib/nginx
  --add-dynamic-module=../${_fancyindex_name}-${_fancyindex_ver}
  --add-dynamic-module=../${_echo_name}-${_echo_ver}
  --add-dynamic-module=../${_heads_more_name}-${_heads_more_ver}
  --add-dynamic-module=../${_fair_name}-${_fair_ver}
  --add-dynamic-module=../${_sub_filter_name}-${_sub_filter_ver}
  --add-dynamic-module=../${_google_filter_name}-${_google_filter_ver}
  --add-dynamic-module=../${_auth_pam_name}-${_auth_pam_ver}
  --add-dynamic-module=../${_concat_name}-${_concat_ver}
  --add-dynamic-module=../${_naxsi_name}-${_naxsi_ver}/naxsi_src
  --add-dynamic-module=../${_nchan_name}-${_nchan_ver}
  --add-dynamic-module=../${_rtmp_name}-${_rtmp_ver}
  --add-dynamic-module=../${_pagespeed_name}-${_pagespeed_ver}  
)

prepare() {
  cd ${_fancyindex_name}-${_fancyindex_ver}
  sed -i 's/Parent directory/\.\./' ngx_http_fancyindex_module.c template.h
  sed -i 's/File Name/文件名/;s/File Size/文件大小/;s/Date/日期/' template.h # zh ..

  cd ../${_fair_name}-${_fair_ver}
  cat >./config <<'EOF'
ngx_addon_name=ngx_http_upstream_fair_module
if test -n "$ngx_module_link"; then
    ngx_module_type=HTTP
    ngx_module_name=ngx_http_upstream_fair_module
    ngx_module_srcs="$ngx_addon_dir/ngx_http_upstream_fair_module.c"
    . auto/module
else
    HTTP_MODULES="$HTTP_MODULES ngx_http_upstream_fair_module"
    NGX_ADDON_SRCS="$NGX_ADDON_SRCS $ngx_addon_dir/ngx_http_upstream_fair_module.c"
fi
EOF

  cd ../${_sub_filter_name}-${_sub_filter_ver}
  cat >./config <<'EOF'
ngx_addon_name=ngx_http_subs_filter_module
if test -n "$ngx_module_link"; then
    ngx_module_type=HTTP_AUX_FILTER
    ngx_module_name=ngx_http_subs_filter_module
    ngx_module_srcs="$ngx_addon_dir/ngx_http_subs_filter_module.c"
    . auto/module
else
    HTTP_AUX_FILTER_MODULES="$HTTP_AUX_FILTER_MODULES ngx_http_subs_filter_module"
    NGX_ADDON_SRCS="$NGX_ADDON_SRCS $ngx_addon_dir/ngx_http_subs_filter_module.c"
fi
EOF

  cd ../${_google_filter_name}-${_google_filter_ver}
  cat >./config <<'EOF'
ngx_addon_name=ngx_http_google_filter_module
if test -n "$ngx_module_link"; then
    ngx_module_type=HTTP_AUX_FILTER
    ngx_module_name=ngx_http_google_filter_module
    ngx_module_srcs="$ngx_addon_dir/src/*.c"
    . auto/module
else
    HTTP_AUX_FILTER_MODULES="$HTTP_AUX_FILTER_MODULES ngx_http_google_filter_module"
    NGX_ADDON_SRCS="$NGX_ADDON_SRCS $ngx_addon_dir/src/*.c"
    NGX_ADDON_DEPS="$NGX_ADDON_DEPS $ngx_addon_dir/src/*.h"
fi
EOF
sed -i '/apis.*google.*com/a \
                                         "$google_host/!$1",\
                                         "igr"))\
      break;\
    \
    if (ngx_http_google_inject_subs_args(cf,\
                                         "subs_filter", 3, \
                                         "((id)\\.google\\.com)",' src/ngx_http_google_inject.c

  cd ../${_concat_name}-${_concat_ver}
  cat >./config <<'EOF'
ngx_addon_name=ngx_http_concat_module
if test -n "$ngx_module_link"; then
    ngx_module_type=HTTP
    ngx_module_name=$ngx_addon_name
    ngx_module_srcs="$ngx_addon_dir/ngx_http_concat_module.c"
    . auto/module
else
    HTTP_MODULES="$HTTP_MODULES ngx_http_concat_module"
    NGX_ADDON_SRCS="$NGX_ADDON_SRCS $ngx_addon_dir/ngx_http_concat_module.c"
fi
EOF

  cd ../${_pagespeed_name}-${_pagespeed_ver}/
  [ -d psol ] && rm -r psol/
  mv ../psol ./
}

build() {
  cd ${_pkgname}-${_pkgver}

  ./configure \
    --prefix=/etc/nginx \
    --conf-path=/etc/nginx/nginx.conf \
    --sbin-path=/usr/bin/nginx \
    --pid-path=/run/nginx.pid \
    --lock-path=/run/lock/nginx.lock \
    --user=http \
    --group=http \
    --http-log-path=/var/log/nginx/access.log \
    --error-log-path=stderr \
    --http-client-body-temp-path=/var/lib/nginx/client-body \
    --http-proxy-temp-path=/var/lib/nginx/proxy \
    --http-fastcgi-temp-path=/var/lib/nginx/fastcgi \
    --http-scgi-temp-path=/var/lib/nginx/scgi \
    --http-uwsgi-temp-path=/var/lib/nginx/uwsgi \
    ${_common_flags[@]} \
    ${_stable_flags[@]} \
    ${_3d_party_modules_flags[@]}

  make
}

package_mynginx() {
  conflicts=('nginx')
  provides=('nginx')
  backup=('etc/nginx/fastcgi.conf'
          'etc/nginx/fastcgi_params'
          'etc/nginx/koi-win'
          'etc/nginx/koi-utf'
          'etc/nginx/mime.types'
          'etc/nginx/nginx.conf'
          'etc/nginx/scgi_params'
          'etc/nginx/uwsgi_params'
          'etc/nginx/win-utf'
          'etc/logrotate.d/nginx')
  install=nginx.install

  cd ${_pkgname}-${_pkgver}
  make DESTDIR="$pkgdir" install

  sed -e 's|\<user\s\+\w\+;|user html;|g' \
    -e '44s|html|/usr/share/nginx/html|' \
    -e '54s|html|/usr/share/nginx/html|' \
    -i "$pkgdir"/etc/nginx/nginx.conf

  rm "$pkgdir"/etc/nginx/*.default

  install -d "$pkgdir"/var/lib/nginx
  install -dm700 "$pkgdir"/var/lib/nginx/proxy

  chmod 750 "$pkgdir"/var/log/nginx
  chown http:log "$pkgdir"/var/log/nginx

  install -d "$pkgdir"/usr/share/nginx
  mv "$pkgdir"/etc/nginx/html/ "$pkgdir"/usr/share/nginx

  install -Dm644 ../logrotate "$pkgdir"/etc/logrotate.d/nginx
  install -Dm644 ../service "$pkgdir"/usr/lib/systemd/system/nginx.service
  install -Dm644 LICENSE "$pkgdir"/usr/share/licenses/${_pkgname}/LICENSE

  rmdir "$pkgdir"/run

  install -d "$pkgdir"/usr/share/man/man8/
  gzip -9c man/nginx.8 > "$pkgdir"/usr/share/man/man8/nginx.8.gz

  for i in ftdetect indent syntax; do
    install -Dm644 contrib/vim/${i}/nginx.vim \
      "${pkgdir}/usr/share/vim/vimfiles/${i}/nginx.vim"
  done

  rm "${pkgdir}/usr/lib/nginx"/ngx_pagespeed.so
}

package_mynginx-pagespeed() {
  pkgver=${_NPS_VERSION}
  pkgdesc='Automatic PageSpeed optimization module for Nginx'
  url='https://github.com/pagespeed/ngx_pagespeed'
  depends=("mynginx=${_pkgver}")

  cd ${_pkgname}-${_pkgver}
  install -Dm755 objs/ngx_pagespeed.so "${pkgdir}/usr/lib/nginx"/ngx_pagespeed.so
}
# vim:set ts=2 sw=2 et:
